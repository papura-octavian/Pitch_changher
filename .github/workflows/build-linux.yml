name: Build Linux AppImage

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libasound2-dev libpulse-dev libjack-dev libfuse2
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        
    - name: Make ffmpeg executable
      run: |
        chmod +x ffmpeg/linux/ffmpeg
        chmod +x ffmpeg/linux/ffprobe
        
    - name: Build executable with PyInstaller
      run: |
        pyinstaller --clean --noconfirm Pitch_Changher.spec
        
    - name: Download AppImageTool
      run: |
        wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool.AppImage
        chmod +x appimagetool.AppImage
        
    - name: Create AppDir structure
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        cp dist/PitchShifter AppDir/usr/bin/
        cp -r ffmpeg AppDir/usr/
        
    - name: Create desktop file
      run: |
        cat > AppDir/usr/share/applications/pitchshifter.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=PitchShifter
        Comment=Pitch shifting tool for audio and video files
        Exec=pitchshifter
        Icon=pitchshifter
        Categories=AudioVideo;Audio;Video;
        Terminal=false
        EOF
        
    - name: Create AppRun
      run: |
        cat > AppDir/AppRun << 'EOF'
        #!/bin/bash
        SELF="$(readlink -f "${0}")"
        HERE="$(dirname "${SELF}")"
        exec "${HERE}/usr/bin/PitchShifter" "$@"
        EOF
        chmod +x AppDir/AppRun
        
    - name: Build AppImage
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ "$VERSION" = "$GITHUB_REF" ]; then
          VERSION="dev"
        fi
        # Use --appimage-extract-and-run to avoid FUSE requirement
        ARCH=x86_64 ./appimagetool.AppImage --appimage-extract-and-run AppDir PitchShifter-${VERSION}-x86_64.AppImage
        
    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: PitchShifter-Linux-AppImage
        path: PitchShifter-*.AppImage
        retention-days: 30
        
    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: PitchShifter-*.AppImage
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

